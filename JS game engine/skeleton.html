<!-- A basic 2D HTML + JavaScript game engine, consisting of:
1. Canvas element, 800x600
2. Render loop
3. Update loop
4. Global data for current mouse position, stored as vector class
 -->

<!DOCTYPE html>
<html>
<head>
	<title>Game Engine</title>
	<style type="text/css">
		canvas {
			border: 1px solid black;
		}
	</style>
	<script type="text/javascript" src="Vector2D.js"></script>
	<script type="text/javascript" src="Sprite.js"></script>
</head>
<body>
	<canvas id="gameCanvas" width="800" height="600"></canvas>
	<script type="text/javascript">
		// Get the canvas element
		var canvas = document.getElementById("gameCanvas");
		// Get the 2D context
		var context = canvas.getContext("2d");
		
		// Update user input
		var mousePos = new Vector2D();
		function setMousePosition(e) {
			mousePos.x = e.clientX;
			mousePos.y = e.clientY;
		}
		
		var keyDown = {};
		function handleKeyDown(e) {
			keyDown[event.key] = true;
		}
		
		function handleKeyUp(e) {
			// note for posterity: I have no idea how `e` as the argument name can be understood as `event` in the next line, but it works
			keyDown[event.key] = false;
		}
		
		// Add event listener for mouse movement
		canvas.addEventListener("mousemove", setMousePosition);
		document.addEventListener('keydown', handleKeyDown);
		document.addEventListener('keyup', handleKeyUp);
		
		const playerSize = 48;
		const playerSpeed = 10/100.0; // pixels per millisecond
		let backgroundSprite;
		let playerSprite;
		(async () => {
			backgroundSprite = await Sprite.buildSprite(
				'background.png',
				new Vector2D(0, 0),
				new Vector2D(canvas.width, canvas.height),
				context
			);
			
			playerSprite = await Sprite.buildSprite(
				'player-ship.png',
				new Vector2D((canvas.width-playerSize) / 2, canvas.height-playerSize),
				new Vector2D(playerSize, playerSize),
				context
			);
		})();
		
		function loading() {
			return (
				backgroundSprite == undefined ||
				playerSprite == undefined
			);
		}
		
		var lastCallTime = Date.now();
		
		// Render loop
		function render() {
			if (loading()) { return }
			
			backgroundSprite.draw();
			
			playerSprite.draw();
		}
		
		// Update loop; deltaTime is milliseconds
		function update(deltaTime) {
			if (loading()) { return }
			
			if (keyDown["ArrowLeft"]) {
				playerSprite.position.x -= playerSpeed * deltaTime;
			}
			if (keyDown["ArrowRight"]) {
				playerSprite.position.x += playerSpeed * deltaTime;
			}
			if (keyDown["ArrowUp"]) {
				playerSprite.position.y -= playerSpeed * deltaTime;
			}
			if (keyDown["ArrowDown"]) {
				playerSprite.position.y += playerSpeed * deltaTime;
			}
		}
		
		// Game loop
		function loop() {
			var currentTime = Date.now();
			var deltaTime = currentTime - lastCallTime;
			lastCallTime = currentTime;
			update(deltaTime);
			render();
			// Call the loop function again
			window.requestAnimationFrame(loop);
		}
		
		// Call the loop function for the first time
		loop();
	</script>
</body>
</html>