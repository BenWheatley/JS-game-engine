<!-- A basic 2D HTML + JavaScript game engine, consisting of:
1. Canvas element, 800x600
2. Render loop
3. Update loop
4. Global data for current mouse position, stored as vector class
 -->

<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Retro Space Shooter</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link id="css" rel="stylesheet" href="css.css"/ >
	<script type="text/javascript" src="DebugLogger.js"></script>
	<script>
		// Enable debug logging only when running on localhost
		DebugLogger.debug = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
	</script>
	<script type="text/javascript" src="GameConfig.js"></script>
	<script type="text/javascript" src="AssetLoader.js"></script>
	<script type="text/javascript" src="CollisionDetection.js"></script>
	<script type="text/javascript" src="VibeEngine.js"></script>
	<script type="text/javascript" src="Vector2D.js"></script>
	<script type="text/javascript" src="Particle.js"></script>
	<script type="text/javascript" src="ParticleSystem.js"></script>
	<script type="text/javascript" src="NPCAIUtils.js"></script>
	<script type="text/javascript" src="SpawnSystem.js"></script>
	<script type="text/javascript" src="GameState.js"></script>
    <script type="text/javascript" src="GameEntity.js"></script>
    <script type="text/javascript" src="Game.js"></script>
	<script type="text/javascript" src="Sprite.js"></script>
	<script type="text/javascript" src="NPC.js"></script>
	<script type="text/javascript" src="AlienScout.js"></script>
	<script type="text/javascript" src="AlienFighter.js"></script>
	<script type="text/javascript" src="Asteroid.js"></script>
	<script type="text/javascript" src="AsteroidSpawn.js"></script>
	<script type="text/javascript" src="Wormhole.js"></script>
	<script type="text/javascript" src="UpgradeBackground.js"></script>
	<script type="text/javascript" src="Projectile.js"></script>
	<script type="text/javascript" src="Laser.js"></script>
	<script type="text/javascript" src="Plasma.js"></script>
	<script type="text/javascript" src="Missile.js"></script>
	<script type="text/javascript" src="MissileCruiser.js"></script>
	<script type="text/javascript" src="AlienSaucer.js"></script>
	<script type="text/javascript" src="Player.js"></script>
	<script type="text/javascript" src="SoundManager.js"></script>
	<script type="text/javascript" src="SimpleMusic.js"></script>
	<script type="text/javascript" src="MusicPlayer.js"></script>
	<script type="text/javascript" src="MenuSystem.js"></script>
	<script type="text/javascript" src="PreferencesManager.js"></script>
	<script type="text/javascript" src="HighScoreManager.js"></script>
	<script type="text/javascript" src="AchievementManager.js"></script>
	<script type="text/javascript" src="Minimap.js"></script>
</head>
<body>
	<div id="gameContainer">
		<canvas id="gameCanvas" width="800" height="600"></canvas>
		<div id="menuOverlay">
			<div class="menu-title" id="menuTitle">
				<img id="menuTitleImage" src="title.png" alt="SPACE SHOOTER" style="width: 325px; height: 28px;">
			</div>
			<div class="menu-buttons" id="menuButtons"></div>
			<div class="menu-instructions" id="menuInstructions"></div>
		</div>
	</div>
	<script type="text/javascript">
		const canvasName = "gameCanvas";
		// Get the canvas element
		const canvas = document.getElementById(canvasName);
		// Get the 2D context
		const context = canvas.getContext("2d");
		
		const engine = VibeEngine.begin(document, canvasName);
		Sprite.begin(context);

		// Initialize menu system
		const menuSystem = new MenuSystem(
			document.getElementById('menuOverlay'),
			document.getElementById('menuTitle'),
			document.getElementById('menuButtons'),
			document.getElementById('menuInstructions')
		);

		// Initialize high score manager
		const highScoreManager = new HighScoreManager(menuSystem);

		// Initialize achievement manager
		const achievementManager = new AchievementManager(menuSystem);

		// Preferences Management
		const preferencesManager = new PreferencesManager();

		// Initialize sound manager and music player
		const soundManager = SoundManager.init();
		const musicPlayer = new MusicPlayer();

		// Preload assets
		(async () => {
			await AssetLoader.loadAll(soundManager, musicPlayer);

			// Initialize music volume after Note class is available
			Note.setVolume(preferencesManager.musicVolume / 100);
		})();

		// Background will be tiled - store a single tile sprite
		let backgroundTileSize = new Vector2D(1536, 1024); // Actual size of background image
		let backgroundSprite = new Sprite(
			'background-fuzzy-edge.png',
			new Vector2D(0, 0),
			backgroundTileSize
		);

		// Initialize game state
		const gameState = new GameState(canvas);
		
		const game = new Game();

		// Game state management functions
		async function startGame() {
			// Resume audio context on user interaction (required by browser autoplay policies)
			await SoundManager.resumeAudioContext();

			gameState.reset();
			gameState.currentState = GameState.States.PLAYING;
			menuSystem.hideMenu();
			musicPlayer.play();
			setCursorVisibility(false);
		}

		function returnToMenu() {
			gameState.currentState = null; // No longer in active gameplay
			// Don't stop music - keep playing in menus
			setCursorVisibility(true);
			showMainMenu();
		}

		// Menu configuration functions
		function showMainMenu() {
			setMenuOverlayMode(false); // Opaque overlay with background

			// Start music if not already playing
			if (!musicPlayer.isPlaying) {
				musicPlayer.play();
			}

			// Restore title image if it was replaced by text
			const titleElement = document.getElementById('menuTitle');
			if (!titleElement.querySelector('img')) {
				titleElement.innerHTML = '<img id="menuTitleImage" src="title.png" alt="SPACE SHOOTER" style="width: 325px; height: 28px;">';
			}

			menuSystem.showMenu(MenuSystem.MenuTypes.MAIN, {
				title: 'SPACE SHOOTER',
				items: [
					{
						type: 'button',
						label: 'New Game',
						action: () => startGame()
					},
					{
						type: 'button',
						label: 'High Scores',
						action: () => highScoreManager.showHighScoresMenu()
					},
					{
						type: 'button',
						label: 'Options',
						action: () => showOptionsMenu()
					},
					{
						type: 'button',
						label: 'Achievements',
						action: () => showAchievementsMenu()
					}
				],
				instructions: 'Arrow Keys or Left Stick: Move | Space or A Button: Shoot | ESC: Pause'
			});
		}


		function showGameOverMenu() {
			setMenuOverlayMode(true); // Transparent overlay - show game behind

			let playerName = '';

			// Helper to save score and stop game (shared by all buttons)
			const saveAndStopGame = () => {
				const name = playerName.trim() || 'Anonymous';
				highScoreManager.saveHighScore(name, gameState.score);
				// Stop game from continuing to update
				gameState.currentState = null;
			};

			// Function to submit the score (shared between button and Enter key)
			const submitScore = () => {
				saveAndStopGame();
				highScoreManager.showHighScoresMenu();
			};

			menuSystem.showMenu(MenuSystem.MenuTypes.GAME_OVER, {
				title: 'GAME OVER',
				items: [
					{
						type: 'textInput',
						id: 'playerNameInput',
						label: 'Enter Your Name:',
						placeholder: 'Player',
						maxLength: 15,
						autofocus: true,
						onChange: (value) => {
							playerName = value;
						},
						onSubmit: submitScore
					},
					{
						type: 'button',
						label: 'Submit Score',
						action: submitScore
					},
					{
						type: 'button',
						label: 'New Game',
						action: () => {
							saveAndStopGame();
							startGame();
						}
					},
					{
						type: 'button',
						label: 'Main Menu',
						action: () => {
							saveAndStopGame();
							returnToMenu();
						}
					}
				],
				instructions: `Final Score: ${gameState.score}`
			});
		}

		function pauseGame() {
			if (gameState.currentState === GameState.States.PLAYING) {
				gameState.currentState = GameState.States.PAUSED;
				musicPlayer.pause();
				canvas.classList.remove('hide-cursor');
				showPauseMenu();
			}
		}

		function resumeGame() {
			gameState.currentState = GameState.States.PLAYING;
			menuSystem.hideMenu();
			musicPlayer.play();
			setCursorVisibility(false);
		}

		function showPauseMenu() {
			setMenuOverlayMode(true); // Transparent overlay for pause

			menuSystem.showMenu(MenuSystem.MenuTypes.PAUSE, {
				title: 'PAUSED',
				items: [
					{
						type: 'button',
						label: 'Continue',
						action: () => resumeGame()
					},
					...getVolumeSliders(),
					getFullscreenCheckbox(),
					{
						type: 'button',
						label: 'Quit',
						action: () => {
							if (gameState.score > 0) {
								gameOver();
							} else {
								returnToMenu();
							}
						}
					}
				],
				instructions: ''
			});
		}

		function checkUltimateWeaponAchievement() {
			if (gameState.player.weaponLevel === 10 &&
				gameState.player.engineLevel === 10 &&
				gameState.player.shieldLevel === 10) {
				achievementManager.unlock('ultimate_weapon');
			}
		}

		function showUpgradeMenu() {
			// Check Untouchable achievement before advancing
			if (gameState.achievementStats.damageTakenThisWave === 0) {
				achievementManager.unlock('untouchable');
			}

			// Set upgrading state - time passes but player has no control
			gameState.currentState = GameState.States.UPGRADING;
			musicPlayer.pause();
			setCursorVisibility(true);
			setMenuOverlayMode(true); // Transparent overlay for pause

			// Check max levels
			const maxWeaponLevel = GameConfig.UPGRADES.WEAPON.length - 1;
			const maxEngineLevel = GameConfig.UPGRADES.ENGINE.length - 1;
			const maxShieldLevel = GameConfig.UPGRADES.SHIELD.length - 1;

			const weaponMaxed = gameState.player.weaponLevel >= maxWeaponLevel;
			const engineMaxed = gameState.player.engineLevel >= maxEngineLevel;
			const shieldMaxed = gameState.player.shieldLevel >= maxShieldLevel;
			const allMaxed = weaponMaxed && engineMaxed && shieldMaxed;

			const items = [];

			if (allMaxed) {
				// All upgrades maxed - show "Heal and Continue" button
				items.push({
					type: 'button',
					label: 'Heal and Continue',
					action: () => {
						// Heal to full health
						gameState.player.health = gameState.player.maxHealth;
						DebugLogger.log(`Healed to full health: ${gameState.player.health}`);
						game.resumeFromUpgrade();
					}
				});
			} else {
				// Show upgrade buttons (disabled if maxed)
				items.push({
					type: 'button',
					label: weaponMaxed
						? `Weapon Upgrade (MAX LEVEL)`
						: `Weapon Upgrade (Level ${gameState.player.weaponLevel} → ${gameState.player.weaponLevel + 1})`,
					disabled: weaponMaxed,
					action: () => {
						gameState.player.weaponLevel++;
						DebugLogger.log(`Weapon upgraded to level ${gameState.player.weaponLevel}`);

						// Update weapon upgrade achievement progress
						achievementManager.setProgress('fully_armed', gameState.player.weaponLevel);
						checkUltimateWeaponAchievement();

						game.resumeFromUpgrade();
					}
				});

				items.push({
					type: 'button',
					label: engineMaxed
						? `Engine Upgrade (MAX LEVEL)`
						: `Engine Upgrade (Level ${gameState.player.engineLevel} → ${gameState.player.engineLevel + 1})`,
					disabled: engineMaxed,
					action: () => {
						gameState.player.engineLevel++;
						DebugLogger.log(`Engine upgraded to level ${gameState.player.engineLevel}`);

						// Update engine upgrade achievement progress
						achievementManager.setProgress('speed_demon', gameState.player.engineLevel);
						checkUltimateWeaponAchievement();

						game.resumeFromUpgrade();
					}
				});

				items.push({
					type: 'button',
					label: shieldMaxed
						? `Shield Upgrade (MAX LEVEL)`
						: `Shield Upgrade (Level ${gameState.player.shieldLevel} → ${gameState.player.shieldLevel + 1})`,
					disabled: shieldMaxed,
					action: () => {
						gameState.player.shieldLevel++;
						gameState.player.applyShieldUpgrade(); // Apply max health and heal to full
						DebugLogger.log(`Shield upgraded to level ${gameState.player.shieldLevel}`);

						// Update shield upgrade achievement progress
						achievementManager.setProgress('fortress', gameState.player.shieldLevel);
						checkUltimateWeaponAchievement();

						game.resumeFromUpgrade();
					}
				});
			}

			menuSystem.showMenu(MenuSystem.MenuTypes.UPGRADE, {
				title: allMaxed ? 'ALL UPGRADES COMPLETE' : 'CHOOSE UPGRADE',
				items: items,
				instructions: allMaxed
					? 'You have reached maximum power!'
					: 'Select one upgrade before entering the wormhole'
			});
		}

		function showOptionsMenu() {
			setMenuOverlayMode(false); // Opaque overlay with background

			menuSystem.showMenu(MenuSystem.MenuTypes.OPTIONS, {
				title: 'OPTIONS',
				items: [
					...getVolumeSliders(),
					getFullscreenCheckbox(),
					{
						type: 'button',
						label: 'Back',
						action: () => showMainMenu()
					}
				],
				instructions: ''
			});
		}

		function showAchievementsMenu() {
			setMenuOverlayMode(false); // Opaque overlay with background

			// Build achievement list with unlock status and progress
			const achievementList = GameConfig.ACHIEVEMENTS.map(achievement => {
				return {
					...achievement,
					unlocked: achievementManager.isUnlocked(achievement.id),
					progress: achievementManager.getProgress(achievement.id)
				};
			});

			const unlockedCount = achievementManager.getUnlockedCount();
			const totalCount = achievementManager.getTotalCount();

			menuSystem.showMenu(MenuSystem.MenuTypes.ACHIEVEMENTS, {
				title: 'ACHIEVEMENTS',
				items: [
					{
						type: 'achievementList',
						achievements: achievementList,
						headerText: `${unlockedCount} / ${totalCount} Unlocked`
					},
					{
						type: 'button',
						label: 'Back',
						action: () => showMainMenu()
					}
				],
				instructions: ''
			});
		}

		// Helper: Get volume slider controls (used in Pause and Options menus)
		function getVolumeSliders() {
			return [
				{
					type: 'slider',
					label: 'Sound Effects Volume',
					min: 0,
					max: 100,
					value: preferencesManager.soundEffectsVolume,
					suffix: '%',
					onChange: (value) => {
						preferencesManager.soundEffectsVolume = parseInt(value);
					}
				},
				{
					type: 'slider',
					label: 'Music Volume',
					min: 0,
					max: 100,
					value: preferencesManager.musicVolume,
					suffix: '%',
					onChange: (value) => {
						preferencesManager.musicVolume = parseInt(value);
						Note.setVolume(preferencesManager.musicVolume / 100);
					}
				}
			];
		}

		// Helper: Get fullscreen checkbox control (used in Pause and Options menus)
		function getFullscreenCheckbox() {
			return {
				type: 'checkbox',
				label: 'Fullscreen',
				checked: VibeEngine.instance.isFullScreen,
				onChange: (checked) => {
					if (checked && !VibeEngine.instance.isFullScreen) {
						VibeEngine.instance.enterFullScreen();
					} else if (!checked && VibeEngine.instance.isFullScreen) {
						VibeEngine.instance.exitFullScreen();
					}
				}
			};
		}

		// Helper: Set cursor visibility
		function setCursorVisibility(visible) {
			if (visible) {
				canvas.classList.remove('hide-cursor');
			} else {
				canvas.classList.add('hide-cursor');
			}
		}

		// Helper: Set menu overlay mode (pause = transparent overlay, regular = opaque)
		function setMenuOverlayMode(isPauseMode) {
			const overlay = document.getElementById('menuOverlay');
			if (isPauseMode) {
				overlay.classList.add('pause');
			} else {
				overlay.classList.remove('pause');
			}
		}

		// Wrapper functions for game loop
		function update(deltaTime) {
			game.update(deltaTime);
		}

		function render() {
			game.render();
		}

		// Show main menu and start game loop
		showMainMenu();
		engine.start(update, render, () => Sprite.stillLoading());
	</script>
</body>
</html>