<!-- A basic 2D HTML + JavaScript game engine, consisting of:
1. Canvas element, 800x600
2. Render loop
3. Update loop
4. Global data for current mouse position, stored as vector class
 -->

<!DOCTYPE html>
<html>
<head>
	<title>Game Engine</title>
	<style type="text/css">
		canvas {
			border: 1px solid black;
		}
	</style>
	<script type="text/javascript" src="GPTEngine.js"></script>
	<script type="text/javascript" src="Vector2D.js"></script>
	<script type="text/javascript" src="Sprite.js"></script>
</head>
<body>
	<canvas id="gameCanvas" width="800" height="600"></canvas>
	<script type="text/javascript">
		const canvasName = "gameCanvas";
		// Get the canvas element
		const canvas = document.getElementById(canvasName);
		// Get the 2D context
		const context = canvas.getContext("2d");
		
		const engine = GPTEngine.begin(document, canvasName);
		Sprite.begin(context);
		
		const playerSize = 48;
		const playerSpeed = 10/100.0; // pixels per millisecond
		const alienSize = 48;
		const alienSpeed = 10/100.0; // pixels per millisecond
		let backgroundSprite;
		let playerSprite;
		let aliens = [];
		let alienDelayMilliseconds = 5000;
		let lastAlienTime = Date.now();
		(async () => {
			await Sprite.preloadSprite('background.png');
			await Sprite.preloadSprite('player-ship.png');
			await Sprite.preloadSprite('alien-ship.png');
		})();
		
		backgroundSprite = new Sprite(
			'background.png',
			new Vector2D(0, 0),
			new Vector2D(canvas.width, canvas.height)
		);
		playerSprite = new Sprite(
			'player-ship.png',
			new Vector2D((canvas.width-playerSize) / 2, canvas.height-playerSize),
			new Vector2D(playerSize, playerSize),
		);
		
		function loading() {
			return Sprite.stillLoading();
		}
		
		// Render loop
		function render() {
			if (loading()) { return; }
			
			backgroundSprite.draw();
			
			playerSprite.draw();
			
			for (const alien of aliens) {
				alien.draw();
			}
		}
		
		// Update loop; deltaTime is milliseconds
		function update(deltaTime) {
			if (loading()) { return; }
			
			if (engine.keyDown["ArrowLeft"]) {
				playerSprite.position.x -= playerSpeed * deltaTime;
			}
			if (engine.keyDown["ArrowRight"]) {
				playerSprite.position.x += playerSpeed * deltaTime;
			}
			if (engine.keyDown["ArrowUp"]) {
				playerSprite.position.y -= playerSpeed * deltaTime;
			}
			if (engine.keyDown["ArrowDown"]) {
				playerSprite.position.y += playerSpeed * deltaTime;
			}
			
			// Toggle fullscreen on ESC key
			if (engine.keyDown["Escape"]) {
				engine.keyDown["Escape"] = false;
				GPTEngine.instance.toggleFullScreen();
			}
			
			if (Date.now() > lastAlienTime + alienDelayMilliseconds) {
				lastAlienTime = Date.now();
				const newAlienSprite = new Sprite(
					'alien-ship.png',
					new Vector2D(Math.random() * (canvas.width - alienSize), -alienSize),
					new Vector2D(alienSize, alienSize)
				);
				aliens.push(newAlienSprite);
			}
			
			for (const alien of aliens) {
				alien.position.y += alienSpeed;
			}
		}
		
		// Game loop
		var lastCallTime = Date.now();
		function loop() {
			var currentTime = Date.now();
			var deltaTime = currentTime - lastCallTime;
			lastCallTime = currentTime;
			update(deltaTime);
			render();
			// Call the loop function again
			window.requestAnimationFrame(loop);
		}
		
		// Call the loop function for the first time
		loop();
	</script>
</body>
</html>